# 가상 DOM

#### 가상 DOM이란
HTML문서를 자바스크립트 객체로 모델링한 것이다.

#### 가상 DOM을 먼저 업데이트하는 이유
실제 DOM의 업데이트가 다소 느리고 비용이 많이 들 수 있기 때문이다.

#### 실제 DOM
웹 브라우저는 HTML 페이지를 읽어 들이고 나면, 구문을 분석해 노드와 객체의 트리, 즉 DOM (객체 모델)로 변환한다. DOM은 커다란 자바스크립트 객체이다.

#### 실제 DOM의 문제점
- 성능
    - 엘리먼트의 추가나 제거, 엘리먼트의 텍스트나 속성 업데이트 등으로 DOM을 변경할 때마다 브라우저는 레이아웃을 다시 계산하고 페이지의 영향을 받는 부분을 다시 그린다. (=리플로우 발생)
    - getBoundingClientRect()는 한번의 호출로 여러 레이아웃 속성을 검색해 리플로우의 발생 횟수를 줄여줄 수 있다. 읽기/쓰기 작업을 종류별로 나눠 일괄 처리하면 레이아웃 스래싱 현상이 최소화 된다.
        - offsetWidth 같은 레이아웃 속성에 접근할 때 발생하는 리플로우의 횟수를 줄여 성능향상을 시킬수 있다. 그러나 대기중인 레이아웃 변경 사항이 있을 때는 getBoundingClientRect()도 리플로우를 일으킬 수 있다.
    - offsetWidth 같은 레이아웃 의존 속성을 읽을 때는 예기치 않은 성능 문제가 생길 수 있으므로 주의해야 한다. 이러한 속성의 값을 여러번 읽어야 하는 경우에는 변수에 값을 캐싱해서 불필요한 레이아웃 재계산을 피할수도 있다. 브라우저가 레이아웃 계산을 이미 수행한 경우라면 requestAnimationFrame API를 사용해 다음 애니메이션 프레임까지 속성 읽기를 미룰 수 있다.

- 브라우저 간 호환성
    - 특정 DOM 엘리먼트와 속성을 지원하지 않는 브라우저가 있을 수도 있다.
        - React의 합성 이벤트 시스템(Synthetic Event System)이 이러한 문제를 해결하고자 했다.
    - SyntheticEvent는 브라우저의 기본 이벤트를 둘러싼 래퍼 객체로, 여러 브라우저에서 일관성을 보장하기 위해 설계되었다.
        - 메커니즘
            - 통합 인터페이스
                - 이벤트 속성에 접근하는 방법이 브라우저마다 달랐다. event.target 혹은 event.srcElement 등을 추상화해 이벤트와 상호 작용하는 일관된 방법을 제공하여 개발자가 특정 브라우저에 맞춘 개별코드 작성작업을 줄여줬다.
            - 이벤트 위임
                - 리액트는 이벤트 리스너를 엘리먼트에 직접 추가하지 않고 대신 루트에서 이벤트를 받는다. 이러한 접근방식은 구형 브라우저의 특정 엘리먼트에서 일부 이벤트를 사용할 수 없는 문제를 방지한다.
            - 다양한 기능 개선
                - 일부 브라우저에서 onChange 이벤트는 값이 변경되는 즉지 발생하지 않고 입력이 포커스를 읽은 경우에만 발생한다. 이러한 입력 엘리먼트 전체에서 onChange 이벤트의 동작을 정규화 했다. 리액트에서는 키를 입력할때마다 발생해 실시간으로 피드백을 제공한다.
            - 네이티브 이벤트 접근
                - 웹 브라우저에서 네이티브 이벤트가 필요한 경우 event.nativeEvent를 통해 접근할수 있다.

#### 문서 조각
- DOM 노드를 저장하는 가벼운 컨테이너
    - DOM이 업데이트 될때마다 브라우저는 레이아웃 재계산, UI 리페인팅, 화면업데이트 등을 수행하므로 속도가 느려질 수 있다. 이때 문서조각의 역활이 중요하다.
```tsx
    const fragment = document.createDocumentFragment();
    for (let i = 0; i < 100; i++) {
        const li = document.createElement("li");
        li.textContent = `목록 항목 ${i + 1}`;
        fragment.appendChild(li);
    }
    document.getElementById("myList").appendChild(fragment);
```

100개의 목록을 먼저 문서 조각에 추가한다. 그 후에 문서 조각을 기존 목록에 추가한다. 덕분에 문서의 실제 DOM은 각각 100번이 아니라 단 한번 업데이트 된다.

- 리액트의 가상DOM은 문서 조각 개념을 더 나은 방식으로 구현한 것으로 볼 수 있다.
    - 효율적인 비교 알고리즘
        - 변경 사항이 적용되고 현재 가상 DOM과 실제 DOM의 차이점을 확인한다.
    - 단일 렌더링
        - 차이점이 식별되면 리액트는 단 한번의 일괄 처리를 통해 실제 DOM을 업데이트 한다. 문서조각과 비슷한 동작이며 이를 통해 비용이 많이 드는 리플로우와 리페인팅을 최소화한다.

#### 가상 DOM 작동 방식



